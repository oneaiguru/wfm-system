import React, { useState, useEffect } from 'react';
import './MobileLogin.css';

interface BiometricCredentials {
  type: 'fingerprint' | 'face' | 'voice';
  data: string;
}

interface LoginCredentials {
  username: string;
  password: string;
  biometric?: BiometricCredentials;
  deviceId?: string;
}

interface MobileLoginProps {
  onLogin: (credentials: LoginCredentials) => Promise<void>;
  loading?: boolean;
}

const MobileLogin: React.FC<MobileLoginProps> = ({ onLogin, loading = false }) => {
  const [credentials, setCredentials] = useState<LoginCredentials>({
    username: '',
    password: ''
  });
  const [biometricSupported, setBiometricSupported] = useState(false);
  const [biometricEnabled, setBiometricEnabled] = useState(false);
  const [showPassword, setShowPassword] = useState(false);
  const [loginAttempts, setLoginAttempts] = useState(0);
  const [isLocked, setIsLocked] = useState(false);
  const [rememberDevice, setRememberDevice] = useState(false);

  useEffect(() => {
    checkBiometricSupport();
    loadSavedCredentials();
    generateDeviceId();
  }, []);

  const checkBiometricSupport = async () => {
    try {
      // Check if device supports biometric authentication
      if ('credentials' in navigator && 'create' in navigator.credentials) {
        const available = await (navigator.credentials as any).create({
          publicKey: {
            challenge: new Uint8Array(32),
            rp: { name: 'WFM Mobile' },
            user: {
              id: new Uint8Array(16),
              name: 'test',
              displayName: 'Test User'
            },
            pubKeyCredParams: [{ alg: -7, type: 'public-key' }],
            authenticatorSelection: {
              authenticatorAttachment: 'platform',
              userVerification: 'required'
            }
          }
        });
        
        if (available) {
          setBiometricSupported(true);
          setBiometricEnabled(localStorage.getItem('biometric_enabled') === 'true');
        }
      }
    } catch (error) {
      console.log('–ë–∏–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞:', error);
    }
  };

  const loadSavedCredentials = () => {
    const savedUsername = localStorage.getItem('mobile_username');
    const savedRememberDevice = localStorage.getItem('remember_device') === 'true';
    
    if (savedUsername) {
      setCredentials(prev => ({ ...prev, username: savedUsername }));
    }
    setRememberDevice(savedRememberDevice);
  };

  const generateDeviceId = () => {
    let deviceId = localStorage.getItem('device_id');
    if (!deviceId) {
      deviceId = 'mobile_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
      localStorage.setItem('device_id', deviceId);
    }
    setCredentials(prev => ({ ...prev, deviceId }));
  };

  const authenticateWithBiometric = async (): Promise<BiometricCredentials | null> => {
    try {
      if (!biometricSupported) return null;

      const credential = await (navigator.credentials as any).get({
        publicKey: {
          challenge: new Uint8Array(32),
          allowCredentials: [],
          userVerification: 'required'
        }
      });

      if (credential) {
        return {
          type: 'fingerprint', // Could be enhanced to detect actual type
          data: btoa(String.fromCharCode(...new Uint8Array(credential.response.signature)))
        };
      }
    } catch (error) {
      console.error('–ë–∏–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å:', error);
    }
    return null;
  };

  const handleBiometricLogin = async () => {
    const biometric = await authenticateWithBiometric();
    if (biometric && credentials.username) {
      const loginData = {
        ...credentials,
        biometric
      };
      
      try {
        await callMobileAuthAPI(loginData);
        await onLogin(loginData);
      } catch (error) {
        console.error('–í—Ö–æ–¥ —Å –±–∏–æ–º–µ—Ç—Ä–∏–µ–π –Ω–µ —É–¥–∞–ª—Å—è:', error);
      }
    }
  };

  const handlePasswordLogin = async () => {
    if (!credentials.username || !credentials.password) {
      alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø–∞—Ä–æ–ª—å');
      return;
    }

    if (isLocked) {
      alert('–ê–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ 15 –º–∏–Ω—É—Ç.');
      return;
    }

    try {
      await callMobileAuthAPI(credentials);
      await onLogin(credentials);
      
      // Save credentials if remember device is enabled
      if (rememberDevice) {
        localStorage.setItem('mobile_username', credentials.username);
        localStorage.setItem('remember_device', 'true');
      }
      
      setLoginAttempts(0);
    } catch (error) {
      console.error('–í—Ö–æ–¥ –Ω–µ —É–¥–∞–ª—Å—è:', error);
      handleFailedLogin();
    }
  };

  const callMobileAuthAPI = async (loginData: LoginCredentials) => {
    const response = await fetch('/api/v1/mobile/auth/login', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'User-Agent': 'WFM-Mobile-App',
        'Device-ID': loginData.deviceId || ''
      },
      body: JSON.stringify({
        username: loginData.username,
        password: loginData.password,
        biometric_data: loginData.biometric,
        device_info: {
          platform: navigator.platform,
          user_agent: navigator.userAgent,
          screen_resolution: `${screen.width}x${screen.height}`,
          timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
        },
        remember_device: rememberDevice
      })
    });

    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.message || '–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏');
    }

    const result = await response.json();
    
    // Store auth token
    if (result.access_token) {
      localStorage.setItem('mobile_auth_token', result.access_token);
      if (result.refresh_token) {
        localStorage.setItem('mobile_refresh_token', result.refresh_token);
      }
    }

    return result;
  };

  const handleFailedLogin = () => {
    setLoginAttempts(prev => prev + 1);
    
    if (loginAttempts >= 4) {
      setIsLocked(true);
      setTimeout(() => setIsLocked(false), 15 * 60 * 1000); // 15 minutes lock
    }
  };

  const enableBiometric = async () => {
    const biometric = await authenticateWithBiometric();
    if (biometric) {
      setBiometricEnabled(true);
      localStorage.setItem('biometric_enabled', 'true');
      alert('–ë–∏–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –≤–∫–ª—é—á–µ–Ω–∞');
    }
  };

  return (
    <div className="mobile-login">
      <div className="mobile-login__container">
        <div className="mobile-login__header">
          <div className="mobile-login__logo">
            <svg viewBox="0 0 24 24" className="mobile-login__logo-icon">
              <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" 
                    stroke="currentColor" strokeWidth="2" fill="none" strokeLinecap="round" strokeLinejoin="round"/>
            </svg>
          </div>
          <h1 className="mobile-login__title">WFM –ú–æ–±–∏–ª—å–Ω—ã–π</h1>
          <p className="mobile-login__subtitle">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</p>
        </div>

        <div className="mobile-login__form">
          <div className="mobile-login__field">
            <label className="mobile-login__label">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
            <input
              type="text"
              className="mobile-login__input"
              value={credentials.username}
              onChange={(e) => setCredentials(prev => ({ ...prev, username: e.target.value }))}
              placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
              autoComplete="username"
              disabled={loading}
            />
          </div>

          <div className="mobile-login__field">
            <label className="mobile-login__label">–ü–∞—Ä–æ–ª—å</label>
            <div className="mobile-login__password-field">
              <input
                type={showPassword ? 'text' : 'password'}
                className="mobile-login__input"
                value={credentials.password}
                onChange={(e) => setCredentials(prev => ({ ...prev, password: e.target.value }))}
                placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å"
                autoComplete="current-password"
                disabled={loading}
              />
              <button
                type="button"
                className="mobile-login__password-toggle"
                onClick={() => setShowPassword(!showPassword)}
                disabled={loading}
              >
                {showPassword ? 'üëÅÔ∏è' : 'üëÅÔ∏è‚Äçüó®Ô∏è'}
              </button>
            </div>
          </div>

          <div className="mobile-login__options">
            <label className="mobile-login__checkbox">
              <input
                type="checkbox"
                checked={rememberDevice}
                onChange={(e) => setRememberDevice(e.target.checked)}
                disabled={loading}
              />
              <span className="mobile-login__checkbox-text">–ó–∞–ø–æ–º–Ω–∏—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</span>
            </label>
          </div>

          <button
            className="mobile-login__button mobile-login__button--primary"
            onClick={handlePasswordLogin}
            disabled={loading || isLocked}
          >
            {loading ? '–í—Ö–æ–¥...' : isLocked ? '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ' : '–í–æ–π—Ç–∏'}
          </button>

          {biometricSupported && (
            <div className="mobile-login__biometric">
              {biometricEnabled ? (
                <button
                  className="mobile-login__button mobile-login__button--biometric"
                  onClick={handleBiometricLogin}
                  disabled={loading || !credentials.username}
                >
                  üîê –í—Ö–æ–¥ –ø–æ –±–∏–æ–º–µ—Ç—Ä–∏–∏
                </button>
              ) : (
                <button
                  className="mobile-login__button mobile-login__button--secondary"
                  onClick={enableBiometric}
                  disabled={loading}
                >
                  üîí –í–∫–ª—é—á–∏—Ç—å –±–∏–æ–º–µ—Ç—Ä–∏—é
                </button>
              )}
            </div>
          )}

          {loginAttempts > 0 && (
            <div className="mobile-login__warning">
              ‚ö†Ô∏è –ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ. –ü–æ–ø—ã—Ç–æ–∫: {loginAttempts}/5
            </div>
          )}
        </div>

        <div className="mobile-login__footer">
          <p className="mobile-login__version">v2.0.0 ‚Ä¢ –°–±–æ—Ä–∫–∞ 240715</p>
          <p className="mobile-login__copyright">¬© 2024 WFM Enterprise</p>
        </div>
      </div>
    </div>
  );
};

export default MobileLogin;